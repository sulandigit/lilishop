# 购物车模块分析文档

## 一、模块概述

购物车模块是电商系统的核心模块之一，负责处理商品加购、价格计算、优惠券使用、运费计算以及订单创建等业务逻辑。该模块采用了**渲染管道模式**，通过多个渲染步骤（Render Step）依次处理购物车数据，最终完成价格计算和订单创建。

### 主要功能
- 购物车商品管理（增删改查、选中状态管理）
- 多种购物类型支持（普通购物车、立即购买、拼团、积分、砍价等）
- 价格计算（商品价格、促销优惠、优惠券、运费等）
- 收货地址和配送方式管理
- 订单创建和交易生成

---

## 二、核心数据结构

### 2.1 购物车类型枚举 (CartTypeEnum)

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/entity/enums/CartTypeEnum.java`

```java
public enum CartTypeEnum {
    CART,        // 购物车
    BUY_NOW,     // 立即购买
    VIRTUAL,     // 虚拟商品
    PINTUAN,     // 拼团
    POINTS,      // 积分
    KANJIA       // 砍价商品
}
```

每种类型对应不同的业务场景和渲染流程。

---

### 2.2 核心实体类

#### 2.2.1 TradeDTO - 交易数据传输对象

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/entity/dto/TradeDTO.java`

**主要属性**:

| 属性名 | 类型 | 说明 |
|-------|------|------|
| sn | String | 交易编号 |
| parentOrderSn | String | 父订单编号（用于依赖订单） |
| cartList | List\<CartVO\> | 购物车列表（按店铺分组） |
| skuList | List\<CartSkuVO\> | 所有商品SKU列表 |
| priceDetailVO | PriceDetailVO | 价格详情（展示用） |
| priceDetailDTO | PriceDetailDTO | 价格详情（计算用） |
| memberAddress | MemberAddress | 收货地址 |
| storeAddress | StoreAddress | 自提地址 |
| platformCoupon | MemberCouponDTO | 平台优惠券 |
| storeCoupons | Map\<String, MemberCouponDTO\> | 店铺优惠券（key为店铺ID） |
| skuPromotionDetail | Map\<String, String\> | SKU促销关联信息 |
| cartTypeEnum | CartTypeEnum | 购物车类型 |

**核心方法**:
- `getCheckedSkuList()`: 获取已选中的SKU列表
- `removeCoupon()`: 清除优惠券信息

---

#### 2.2.2 CartVO - 购物车视图对象（店铺维度）

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/entity/vo/CartVO.java`

**继承关系**: `CartVO extends CartBase`

**主要属性**:

| 属性名 | 类型 | 说明 |
|-------|------|------|
| skuList | List\<CartSkuVO\> | 该店铺的商品列表 |
| sn | String | 购物车编号 |
| checked | Boolean | 店铺商品是否全选 |
| fullDiscount | FullDiscountVO | 满优惠活动信息 |
| fullDiscountSkuIds | List\<String\> | 参与满优惠的SKU ID列表 |
| isFull | Boolean | 是否满足满优惠条件 |
| couponList | List\<MemberCoupon\> | 可用优惠券列表 |
| canReceiveCoupon | List\<CouponVO\> | 可领取优惠券列表 |
| giftList | List\<String\> | 赠品列表 |
| giftCouponList | List\<String\> | 赠送优惠券列表 |
| giftPoint | Integer | 赠送积分 |
| weight | Double | 总重量 |
| goodsNum | Integer | 商品数量 |
| remark | String | 买家备注 |
| deliveryMethod | String | 配送方式 |
| promotionNotice | String | 促销活动提示 |

**核心方法**:
- `getCheckedSkuList()`: 过滤出已选中的SKU
- `addGoodsNum(Integer goodsNum)`: 累加商品数量

---

#### 2.2.3 CartSkuVO - 购物车商品SKU对象

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/entity/vo/CartSkuVO.java`

**继承关系**: `CartSkuVO extends CartBase`

**主要属性**:

| 属性名 | 类型 | 说明 |
|-------|------|------|
| goodsSku | GoodsSku | SKU详细信息 |
| distributionGoods | DistributionGoods | 分销信息 |
| num | Integer | 购买数量 |
| purchasePrice | Double | 成交价 |
| subTotal | Double | 小计 |
| utilPrice | Double | 实际价格 |
| checked | Boolean | 是否选中 |
| isFreeFreight | Boolean | 是否免运费 |
| invalid | Boolean | 是否失效 |
| errorMessage | String | 错误信息 |
| isShip | Boolean | 是否可配送 |
| pintuanId | String | 拼团活动ID |
| kanjiaId | String | 砍价活动ID |
| pointsId | String | 积分兑换ID |
| point | Long | 积分数量 |
| promotionMap | Map\<String, Object\> | 促销活动集合 |
| cartType | CartTypeEnum | 购物车类型 |
| deliveryMethod | String | 配送方式 |

**核心方法**:
- `rebuildBySku(GoodsSku goodsSku)`: 根据SKU重建购物车项
- `getPromotionMap()`: 获取有效的促销活动（过滤失效促销）
- `getNotFilterPromotionMap()`: 获取未过滤的促销活动

---

#### 2.2.4 CartBase - 购物车基类

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/entity/vo/CartBase.java`

**主要属性**:

| 属性名 | 类型 | 说明 |
|-------|------|------|
| storeId | String | 店铺ID |
| storeName | String | 店铺名称 |
| priceDetailDTO | PriceDetailDTO | 价格计算详情 |
| priceDetailVO | PriceDetailVO | 价格展示详情 |

---

#### 2.2.5 PriceDetailDTO - 价格详情计算对象

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/order/entity/dto/PriceDetailDTO.java`

**主要属性**:

| 属性名 | 类型 | 说明 | 计算公式 |
|-------|------|------|---------|
| originalPrice | Double | 订单原始价格 | 用于价格修改计算 |
| goodsPrice | Double | 商品总金额 | 商品原价总和 |
| freightPrice | Double | 配送费 | 运费计算结果 |
| payPoint | Long | 支付积分 | - |
| discountPrice | Double | 优惠金额 | 促销活动优惠总额 |
| couponPrice | Double | 优惠券金额 | 优惠券抵扣金额 |
| distributionCommission | Double | 分销佣金 | 分销返现支出 |
| platFormCommissionPoint | Double | 平台佣金比例 | 百分比 |
| platFormCommission | Double | 平台佣金 | flowPrice × platFormCommissionPoint / 100 |
| siteCouponPrice | Double | 平台优惠券金额 | - |
| siteCouponPoint | Double | 平台优惠券佣金比例 | - |
| siteCouponCommission | Double | 平台优惠券佣金 | siteCouponPrice × siteCouponPoint / 100 |
| updatePrice | Double | 订单修改金额 | - |
| **flowPrice** | **Double** | **流水金额** | **goodsPrice + freightPrice - discountPrice - couponPrice + updatePrice** |
| settlementPrice | Double | 结算价格 | 与商家结算价格（特殊商品） |
| **billPrice** | **Double** | **最终结算金额** | **flowPrice - platFormCommission - distributionCommission** |
| discountPriceDetail | List\<DiscountPriceItem\> | 优惠详情列表 | - |
| joinPromotion | List\<PromotionSkuVO\> | 参与的促销活动 | - |

**核心方法**:
- `recount()`: 重新计算所有价格
- `increase(PriceDetailDTO priceDetailDTO)`: 累加价格
- `accumulationPriceDTO(List<PriceDetailDTO>)`: 批量累加
- `setUpdatePrice(Double updatePrice)`: 设置修改金额并重算
- `promotionPriceHandler()`: 处理促销金额+优惠券金额超过商品金额的情况

---

#### 2.2.6 PriceDetailVO - 价格详情展示对象

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/entity/vo/PriceDetailVO.java`

| 属性名 | 类型 | 说明 |
|-------|------|------|
| originalPrice | Double | 商品原价 |
| freight | Double | 配送费 |
| discountPrice | Double | 优惠金额 |
| payPoint | Long | 支付积分 |
| finalePrice | Double | 最终成交金额 |

---

### 2.3 缓存键前缀

**文件路径**: `/framework/src/main/java/cn/lili/cache/CachePrefix.java:252-279`

购物车相关的缓存键:

| 缓存键 | 说明 |
|-------|------|
| CART_ORIGIN_DATA_PREFIX | 购物车原始数据 |
| CART_SKU_PREFIX | 购物车SKU数据 |
| CART_MEMBER_ID_PREFIX | 购物车视图（按会员ID） |
| CART_PROMOTION_PREFIX | 用户选择的促销信息 |

---

## 三、核心业务逻辑

### 3.1 购物车服务接口 (CartService)

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/service/CartService.java`

#### 主要方法

| 方法 | 说明 | 参数 | 返回值 |
|-----|------|------|--------|
| `readDTO` | 获取整笔交易 | CartTypeEnum | TradeDTO |
| `getCheckedTradeDTO` | 获取勾选的购物车和商品 | CartTypeEnum | TradeDTO |
| `getAllTradeDTO` | 获取所有交易 | - | TradeDTO |
| `add` | 加入购物车 | skuId, num, cartType, cover | void |
| `checked` | 更新选中状态 | skuId, checked | void |
| `checkedStore` | 更新店铺所有商品选中状态 | storeId, checked | void |
| `checkedAll` | 更新全部选中状态 | checked | void |
| `delete` | 批量删除 | skuIds | void |
| `clean` | 清空购物车 | - | void |
| `resetTradeDTO` | 重新写入购物车 | TradeDTO | void |
| `shippingAddress` | 选择收货地址 | shippingAddressId, way | void |
| `shippingSelfAddress` | 选择自提地址 | shopAddressId, way | void |
| `shippingReceipt` | 选择发票 | ReceiptVO, way | void |
| `shippingMethod` | 选择配送方式 | deliveryMethod, way | void |
| `selectCoupon` | 选择优惠券 | couponId, way, use | void |
| `getCartNum` | 获取购物车商品数量 | checked | Long |
| `getCanUseCoupon` | 获取可用优惠券数量 | CartTypeEnum | Long |
| `createTrade` | 创建交易 | TradeParams | Trade |
| `shippingMethodList` | 获取可用配送方式 | way | List\<String\> |

---

### 3.2 购物车服务实现 (CartServiceImpl)

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/service/CartServiceImpl.java:1-200`

#### 3.2.1 添加商品到购物车 (`add` 方法)

**核心逻辑**:

1. **参数校验**: 检查数量是否大于0
2. **商品校验**: 调用 `checkGoods(skuId)` 检查商品是否可购买
3. **获取促销信息**: `promotionGoodsService.getCurrentGoodsPromotion()`
4. **区分购物车类型**:
   - **CART（普通购物车）**:
     - 读取已有购物车数据
     - 如果商品已存在且未变更，则更新数量（覆盖或累加）
     - 如果商品不存在或已变更，则新增商品项
     - 新加入的商品默认选中
   - **其他类型（立即购买、拼团等）**:
     - 创建新的 TradeDTO
     - 直接添加商品项
     - 调用 `checkCart()` 检查购物车数据
5. **销售模式校验**: `checkGoodsSaleModel()` 检查批发等特殊模式
6. **数据持久化**: 写入缓存

**关键代码片段**:

```java
// 检查并设置商品数量
private void checkSetGoodsQuantity(CartSkuVO cartSkuVO, String skuId, Integer num) {
    // 库存校验、限购校验等
}

// 检查购物车数据（针对特殊购物类型）
private void checkCart(CartTypeEnum cartTypeEnum, CartSkuVO cartSkuVO, String skuId, Integer num) {
    // 拼团、砍价、积分等特殊逻辑
}
```

---

### 3.3 渲染管道架构

购物车模块采用**责任链模式**进行价格计算和数据渲染。

#### 3.3.1 渲染步骤枚举 (RenderStepEnums)

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/entity/enums/RenderStepEnums.java`

| 枚举值 | 说明 | 对应实现类 |
|-------|------|-----------|
| CHECK_DATA | 校验商品 | CheckDataRender |
| CHECKED_FILTER | 选择商品过滤 | CheckedFilterRender |
| SKU_PROMOTION | 商品促销计算 | SkuPromotionRender |
| FULL_DISCOUNT | 满减计算 | FullDiscountRender |
| COUPON | 优惠券价格渲染 | CouponRender |
| SKU_FREIGHT | 运费计算 | SkuFreightRender |
| DISTRIBUTION | 分配促销金额 | DistributionPriceRender |
| PLATFORM_COMMISSION | 平台佣金 | CommissionRender |
| CART_PRICE | 购物车金额计算 | CartPriceRender |
| CART_SN | 交易编号创建 | CartSnRender |

---

#### 3.3.2 渲染步骤声明 (RenderStepStatement)

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/render/RenderStepStatement.java`

定义了不同场景下的渲染流程:

| 场景 | 渲染步骤 | 说明 |
|-----|---------|------|
| **cartRender** | CHECK_DATA → SKU_PROMOTION → FULL_DISCOUNT → CART_PRICE | 购物车页面渲染 |
| **checkedRender** | CHECKED_FILTER → CHECK_DATA → SKU_PROMOTION → FULL_DISCOUNT → COUPON → SKU_FREIGHT → CART_PRICE | 结算页渲染（普通商品） |
| **checkedSingleRender** | CHECK_DATA → SKU_PROMOTION → COUPON → SKU_FREIGHT → CART_PRICE | 结算页渲染（单品：积分、拼团等） |
| **tradeRender** | CHECKED_FILTER → CHECK_DATA → SKU_PROMOTION → FULL_DISCOUNT → COUPON → SKU_FREIGHT → CART_PRICE → CART_SN → DISTRIBUTION → PLATFORM_COMMISSION | 创建交易（普通商品） |
| **singleTradeRender** | CHECK_DATA → SKU_PROMOTION → SKU_FREIGHT → CART_PRICE → CART_SN → DISTRIBUTION → PLATFORM_COMMISSION | 创建交易（单品） |
| **pintuanTradeRender** | CHECK_DATA → SKU_PROMOTION → COUPON → SKU_FREIGHT → CART_PRICE → CART_SN → DISTRIBUTION → PLATFORM_COMMISSION | 创建交易（拼团） |

---

#### 3.3.3 交易构造器 (TradeBuilder)

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/render/TradeBuilder.java`

**核心方法**:

```java
// 构造购物车（展示用）
public TradeDTO buildCart(CartTypeEnum checkedWay) {
    TradeDTO tradeDTO = cartService.readDTO(checkedWay);
    if (checkedWay.equals(CartTypeEnum.CART)) {
        // 购物车页面取消优惠券
        tradeDTO.setStoreCoupons(null);
        tradeDTO.setPlatformCoupon(null);
    }
    renderCartBySteps(tradeDTO, RenderStepStatement.cartRender);
    return tradeDTO;
}

// 构造结算页面
public TradeDTO buildChecked(CartTypeEnum checkedWay) {
    TradeDTO tradeDTO = cartService.readDTO(checkedWay);
    if (isSingle(checkedWay)) {
        renderCartBySteps(tradeDTO, RenderStepStatement.checkedSingleRender);
    } else if (checkedWay.equals(CartTypeEnum.PINTUAN)) {
        renderCartBySteps(tradeDTO, RenderStepStatement.pintuanTradeRender);
    } else {
        renderCartBySteps(tradeDTO, RenderStepStatement.checkedRender);
    }
    return tradeDTO;
}

// 创建交易
public Trade createTrade(TradeDTO tradeDTO) {
    if (isSingle(tradeDTO.getCartTypeEnum())) {
        renderCartBySteps(tradeDTO, RenderStepStatement.singleTradeRender);
    } else if (tradeDTO.getCartTypeEnum().equals(CartTypeEnum.PINTUAN)) {
        renderCartBySteps(tradeDTO, RenderStepStatement.pintuanTradeRender);
    } else {
        renderCartBySteps(tradeDTO, RenderStepStatement.tradeRender);
    }
    return tradeService.createTrade(tradeDTO);
}

// 按步骤渲染
private void renderCartBySteps(TradeDTO tradeDTO, RenderStepEnums[] defaultRender) {
    for (RenderStepEnums step : defaultRender) {
        for (CartRenderStep render : cartRenderSteps) {
            if (render.step().equals(step)) {
                render.render(tradeDTO);
            }
        }
    }
}
```

---

#### 3.3.4 渲染接口 (CartRenderStep)

**文件路径**: `/framework/src/main/java/cn/lili/modules/order/cart/render/CartRenderStep.java`

```java
public interface CartRenderStep {
    RenderStepEnums step();           // 返回渲染步骤枚举
    void render(TradeDTO tradeDTO);   // 执行渲染逻辑
}
```

**实现类列表**:

| 实现类 | 文件路径 |
|-------|---------|
| CheckDataRender | `/framework/.../cart/render/impl/CheckDataRender.java` |
| CheckedFilterRender | `/framework/.../cart/render/impl/CheckedFilterRender.java` |
| SkuPromotionRender | `/framework/.../cart/render/impl/SkuPromotionRender.java` |
| FullDiscountRender | `/framework/.../cart/render/impl/FullDiscountRender.java` |
| CouponRender | `/framework/.../cart/render/impl/CouponRender.java` |
| SkuFreightRender | `/framework/.../cart/render/impl/SkuFreightRender.java` |
| DistributionPriceRender | `/framework/.../cart/render/impl/DistributionPriceRender.java` |
| CommissionRender | `/framework/.../cart/render/impl/CommissionRender.java` |
| CartPriceRender | `/framework/.../cart/render/impl/CartPriceRender.java` |
| CartSnRender | `/framework/.../cart/render/impl/CartSnRender.java` |

---

## 四、API接口

**文件路径**: `/buyer-api/src/main/java/cn/lili/controller/order/CartController.java`

### 4.1 购物车操作接口

| 接口 | 方法 | 路径 | 说明 |
|-----|------|------|------|
| 加入购物车 | POST | `/buyer/trade/carts` | 参数: skuId, num, cartType |
| 获取购物车列表 | GET | `/buyer/trade/carts/all` | 返回所有购物车数据 |
| 获取购物车数量 | GET | `/buyer/trade/carts/count` | 参数: checked（可选） |
| 获取可用优惠券数量 | GET | `/buyer/trade/carts/coupon/num` | 参数: way |
| 更新商品数量 | POST | `/buyer/trade/carts/sku/num/{skuId}` | 参数: skuId, num |
| 更新商品选中状态 | POST | `/buyer/trade/carts/sku/checked/{skuId}` | 参数: skuId, checked |
| 全选/全不选 | POST | `/buyer/trade/carts/sku/checked` | 参数: checked |
| 店铺全选/全不选 | POST | `/buyer/trade/carts/store/{storeId}` | 参数: storeId, checked |
| 删除商品 | DELETE | `/buyer/trade/carts/sku/remove` | 参数: skuIds[] |
| 清空购物车 | DELETE | `/buyer/trade/carts` | 无参数 |

---

### 4.2 结算相关接口

| 接口 | 方法 | 路径 | 说明 |
|-----|------|------|------|
| 获取结算页数据 | GET | `/buyer/trade/carts/checked` | 参数: way |
| 选择收货地址 | GET | `/buyer/trade/carts/shippingAddress` | 参数: shippingAddressId, way |
| 选择自提地址 | GET | `/buyer/trade/carts/storeAddress` | 参数: storeAddressId, way |
| 选择配送方式 | PUT | `/buyer/trade/carts/shippingMethod` | 参数: shippingMethod, way |
| 获取配送方式列表 | GET | `/buyer/trade/carts/shippingMethodList` | 参数: way |
| 选择发票 | GET | `/buyer/trade/carts/select/receipt` | 参数: way, ReceiptVO |
| 选择优惠券 | GET | `/buyer/trade/carts/select/coupon` | 参数: way, memberCouponId, used |
| 创建交易 | POST | `/buyer/trade/carts/create/trade` | 参数: TradeParams（JSON） |

---

## 五、核心流程图

### 5.1 购物车渲染流程

```
购物车页面渲染 (cartRender):
┌─────────────┐
│  读取缓存    │
└──────┬──────┘
       ↓
┌─────────────┐
│ CHECK_DATA  │ ← 校验商品库存、上下架状态
└──────┬──────┘
       ↓
┌─────────────┐
│SKU_PROMOTION│ ← 计算单品促销（限时折扣、秒杀等）
└──────┬──────┘
       ↓
┌─────────────┐
│FULL_DISCOUNT│ ← 计算满减优惠
└──────┬──────┘
       ↓
┌─────────────┐
│ CART_PRICE  │ ← 汇总计算价格
└──────┬──────┘
       ↓
┌─────────────┐
│  返回数据    │
└─────────────┘
```

---

### 5.2 结算页面渲染流程

```
结算页面渲染 (checkedRender):
┌─────────────┐
│  读取缓存    │
└──────┬──────┘
       ↓
┌─────────────┐
│CHECKED_FILTER│ ← 过滤未选中商品
└──────┬──────┘
       ↓
┌─────────────┐
│ CHECK_DATA  │ ← 校验商品
└──────┬──────┘
       ↓
┌─────────────┐
│SKU_PROMOTION│ ← 商品促销
└──────┬──────┘
       ↓
┌─────────────┐
│FULL_DISCOUNT│ ← 满减优惠
└──────┬──────┘
       ↓
┌─────────────┐
│   COUPON    │ ← 优惠券计算
└──────┬──────┘
       ↓
┌─────────────┐
│SKU_FREIGHT  │ ← 运费计算
└──────┬──────┘
       ↓
┌─────────────┐
│ CART_PRICE  │ ← 汇总价格
└──────┬──────┘
       ↓
┌─────────────┐
│  返回数据    │
└─────────────┘
```

---

### 5.3 创建交易流程

```
创建交易 (tradeRender):
┌─────────────┐
│  读取缓存    │
└──────┬──────┘
       ↓
┌─────────────┐
│CHECKED_FILTER│ ← 过滤未选中商品
└──────┬──────┘
       ↓
┌─────────────┐
│ CHECK_DATA  │ ← 二次校验商品
└──────┬──────┘
       ↓
┌─────────────┐
│SKU_PROMOTION│ ← 商品促销
└──────┬──────┘
       ↓
┌─────────────┐
│FULL_DISCOUNT│ ← 满减优惠
└──────┬──────┘
       ↓
┌─────────────┐
│   COUPON    │ ← 优惠券计算
└──────┬──────┘
       ↓
┌─────────────┐
│SKU_FREIGHT  │ ← 运费计算
└──────┬──────┘
       ↓
┌─────────────┐
│ CART_PRICE  │ ← 价格汇总
└──────┬──────┘
       ↓
┌─────────────┐
│  CART_SN    │ ← 生成交易编号
└──────┬──────┘
       ↓
┌─────────────┐
│DISTRIBUTION │ ← 计算分销佣金
└──────┬──────┘
       ↓
┌─────────────┐
│PLATFORM_COM │ ← 计算平台佣金
└──────┬──────┘
       ↓
┌─────────────┐
│创建订单记录  │
└──────┬──────┘
       ↓
┌─────────────┐
│  返回交易    │
└─────────────┘
```

---

## 六、价格计算逻辑

### 6.1 价格计算公式

```
商品原价 (goodsPrice) = Σ (SKU价格 × 数量)

促销优惠 (discountPrice) = 单品促销优惠 + 满减优惠

优惠券优惠 (couponPrice) = 店铺优惠券 + 平台优惠券

运费 (freightPrice) = 根据配送方式计算

流水金额 (flowPrice) = goodsPrice + freightPrice - discountPrice - couponPrice + updatePrice

平台佣金 (platFormCommission) = flowPrice × platFormCommissionPoint / 100

分销佣金 (distributionCommission) = 根据分销设置计算

最终结算金额 (billPrice) = flowPrice - platFormCommission - distributionCommission
```

### 6.2 价格计算优先级

1. **商品原价**: 基础价格
2. **单品促销**: 限时折扣、秒杀等（优先级高）
3. **满减优惠**: 满XX元减XX元
4. **优惠券**: 店铺优惠券 + 平台优惠券
5. **运费**: 根据地址和配送方式计算
6. **订单修改**: 人工调整金额

---

## 七、关键技术点

### 7.1 设计模式

1. **责任链模式**: 渲染步骤按顺序执行
2. **策略模式**: 不同购物车类型使用不同渲染策略
3. **建造者模式**: TradeBuilder 构建交易对象
4. **DTO模式**: 数据传输对象分离展示和计算逻辑

### 7.2 缓存策略

- **缓存键**: 基于会员ID和购物车类型生成
- **缓存内容**: TradeDTO 对象序列化存储
- **缓存更新**: 每次操作后重新构建并写入缓存

### 7.3 数据一致性

1. **商品校验**: 每次渲染时校验商品状态
2. **库存校验**: 加入购物车时校验库存
3. **价格校验**: 使用最新价格和促销信息
4. **锁定机制**: 创建订单时锁定库存

---

## 八、依赖服务

| 服务 | 说明 |
|-----|------|
| GoodsSkuService | 商品SKU服务 |
| PromotionGoodsService | 促销商品服务 |
| MemberCouponService | 会员优惠券服务 |
| MemberAddressService | 会员地址服务 |
| StoreAddressService | 店铺地址服务 |
| PointsGoodsService | 积分商品服务 |
| KanjiaActivityService | 砍价活动服务 |
| WholesaleService | 批发服务 |
| TradeService | 交易服务 |
| Cache | 缓存服务 |

---

## 九、总结

购物车模块通过**渲染管道模式**实现了灵活的价格计算和业务处理流程，支持多种购物场景。核心数据结构清晰，价格计算逻辑严谨，具备良好的扩展性。通过缓存机制提升性能，通过多层校验保证数据一致性。
