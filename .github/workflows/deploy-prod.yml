name: Deploy to Kubernetes (Production)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., 4.3.1)'
        required: true
        type: string
      confirm_deploy:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

env:
  REGISTRY: registry.cn-beijing.aliyuncs.com
  NAMESPACE: lili-images
  K8S_NAMESPACE: lilishop-service

# 防止生产环境并发部署
concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Confirm deployment
        if: ${{ inputs.confirm_deploy != 'DEPLOY' }}
        run: |
          echo "Error: You must type 'DEPLOY' to confirm production deployment"
          exit 1

      - name: Log deployment request
        run: |
          echo "Production deployment requested"
          echo "Image tag: ${{ inputs.image_tag }}"
          echo "Requested by: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
      url: http://www.lilishop.cn
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PROD }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connection
        run: kubectl cluster-info

      - name: Backup current deployment
        run: |
          echo "Backing up current deployment state..."
          kubectl get deployments -n ${{ env.K8S_NAMESPACE }} -o yaml > deployment-backup.yaml || true
          
          # 记录当前镜像版本
          echo "Current image versions:"
          for module in buyer-api seller-api manager-api common-api im-api consumer admin; do
            CURRENT=$(kubectl get deployment $module -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "N/A")
            echo "  $module: $CURRENT"
          done

      - name: Update deployment images
        id: deploy
        run: |
          IMAGE_TAG="${{ inputs.image_tag }}"
          FAILED=""
          
          for module in buyer-api seller-api manager-api common-api im-api consumer admin; do
            echo "Updating $module to ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/$module:$IMAGE_TAG"
            if ! kubectl set image deployment/$module \
              $module=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/$module:$IMAGE_TAG \
              -n ${{ env.K8S_NAMESPACE }}; then
              echo "Warning: Failed to update $module"
              FAILED="$FAILED $module"
            fi
          done
          
          if [ -n "$FAILED" ]; then
            echo "failed_modules=$FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Wait for rollout
        run: |
          echo "Waiting for rollout to complete..."
          FAILED=""
          
          for module in buyer-api seller-api manager-api common-api im-api consumer admin; do
            echo "Checking $module..."
            if ! kubectl rollout status deployment/$module -n ${{ env.K8S_NAMESPACE }} --timeout=600s; then
              echo "Warning: $module rollout failed or timed out"
              FAILED="$FAILED $module"
            fi
          done
          
          if [ -n "$FAILED" ]; then
            echo "Some deployments failed:$FAILED"
            echo "Consider rolling back"
          fi

      - name: Health check
        id: health
        run: |
          echo "Performing health checks..."
          sleep 60  # 等待服务稳定
          
          HEALTHY=true
          
          # 检查所有 pod 状态
          NOT_READY=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} --no-headers | grep -v Running | wc -l)
          
          if [ "$NOT_READY" -gt "0" ]; then
            echo "Warning: $NOT_READY pods are not in Running state"
            kubectl get pods -n ${{ env.K8S_NAMESPACE }}
            HEALTHY=false
          fi
          
          # 检查 pod restart 次数
          HIGH_RESTARTS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.containerStatuses[0].restartCount}{"\n"}{end}' | awk '$2 > 3 {print}')
          
          if [ -n "$HIGH_RESTARTS" ]; then
            echo "Warning: Some pods have high restart counts:"
            echo "$HIGH_RESTARTS"
            HEALTHY=false
          fi
          
          echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, initiating rollback..."
          
          for module in buyer-api seller-api manager-api common-api im-api consumer admin; do
            echo "Rolling back $module..."
            kubectl rollout undo deployment/$module -n ${{ env.K8S_NAMESPACE }} || true
          done
          
          echo "Waiting for rollback to complete..."
          for module in buyer-api seller-api manager-api common-api; do
            kubectl rollout status deployment/$module -n ${{ env.K8S_NAMESPACE }} --timeout=300s || true
          done

      - name: Deployment Summary
        if: always()
        run: |
          echo "# Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ inputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | ${{ env.K8S_NAMESPACE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pod Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Notify on success
        if: needs.deploy.result == 'success'
        run: |
          echo "Production deployment succeeded!"
          echo "Image tag: ${{ inputs.image_tag }}"
          # 添加生产环境部署成功通知
          # curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
          #   -H 'Content-Type: application/json' \
          #   -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"Production 环境部署成功\\n版本: ${{ inputs.image_tag }}\\n操作人: ${{ github.actor }}\"}}"

      - name: Notify on failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "Production deployment failed!"
          # 添加生产环境部署失败告警
          # curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
          #   -H 'Content-Type: application/json' \
          #   -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"Production 环境部署失败!!!\\n版本: ${{ inputs.image_tag }}\\n操作人: ${{ github.actor }}\"}}"
