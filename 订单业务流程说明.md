# 订单业务流程说明

## 一、订单状态概览

### 1.1 订单状态枚举 (OrderStatusEnum)
```java
位置: framework/src/main/java/cn/lili/modules/order/order/entity/enums/OrderStatusEnum.java:9
```

| 状态 | 说明 | 
|------|------|
| UNPAID | 未付款 |
| PAID | 已付款 |
| UNDELIVERED | 待发货 |
| PARTS_DELIVERED | 部分发货 |
| DELIVERED | 已发货 |
| COMPLETED | 已完成 |
| STAY_PICKED_UP | 待自提 |
| TAKE | 待核验（虚拟订单） |
| CANCELLED | 已关闭 |

### 1.2 支付状态枚举 (PayStatusEnum)
```java
位置: framework/src/main/java/cn/lili/modules/order/order/entity/enums/PayStatusEnum.java:9
```

| 状态 | 说明 |
|------|------|
| UNPAID | 待付款 |
| PAID | 已付款 |
| CANCEL | 已取消 |

### 1.3 发货状态枚举 (DeliverStatusEnum)
```java
位置: framework/src/main/java/cn/lili/modules/order/order/entity/enums/DeliverStatusEnum.java:9
```

| 状态 | 说明 |
|------|------|
| UNDELIVERED | 未发货 |
| PARTS_DELIVERED | 部分发货 |
| DELIVERED | 已发货 |
| RECEIVED | 已收货 |

## 二、订单完整业务流程

### 2.1 订单创建阶段

#### 步骤1: 购物车结算
```java
位置: framework/src/main/java/cn/lili/modules/order/cart/service/CartServiceImpl.java
```

用户将商品加入购物车，选择商品进行结算，生成交易DTO（TradeDTO）。

#### 步骤2: 创建交易
```java
位置: framework/src/main/java/cn/lili/modules/order/order/serviceimpl/TradeServiceImpl.java:72
方法: createTrade(TradeDTO tradeDTO)
```

**核心处理流程:**
1. **创建订单预校验** - 验证购物车状态、收货地址、配送区域
2. **优惠券预处理** - 扣除使用的优惠券
3. **积分预处理** - 扣除支付积分
4. **创建Trade记录** - 保存交易主表
5. **创建Order记录** - 调用`orderService.intoDB(tradeDTO)`保存订单
6. **砍价订单处理** - 结束砍价活动
7. **发送MQ消息** - 发送`ORDER_CREATE`消息到消息队列

**初始状态:**
- 订单状态(orderStatus): `UNPAID`
- 支付状态(payStatus): `UNPAID`
- 发货状态(deliverStatus): `UNDELIVERED`

#### 步骤3: 订单入库
```java
位置: framework/src/main/java/cn/lili/modules/order/order/serviceimpl/OrderServiceImpl.java:171
方法: intoDB(TradeDTO tradeDTO)
```

**处理内容:**
1. 循环购物车列表创建订单(Order)
2. 创建订单子项(OrderItem)
3. 记录订单日志(OrderLog)
4. 发送库存更新消息
5. 发送订单状态变更消息

#### 步骤4: 订单创建消息处理
```java
位置: consumer/src/main/java/cn/lili/listener/OrderMessageListener.java:63
```

**消息监听器处理:**
1. 监听`ORDER_CREATE`消息
2. 调用各个事件处理器的`orderCreate`方法
3. 如果订单金额为0，自动完成支付

```java
位置: consumer/src/main/java/cn/lili/event/impl/OrderStatusHandlerExecute.java:43
```

### 2.2 订单支付阶段

#### 步骤5: 订单付款
```java
位置: framework/src/main/java/cn/lili/modules/order/order/service/OrderService.java:139
方法: payOrder(String orderSn, String paymentMethod, String receivableNo)
```

**处理流程:**
1. 更新订单支付信息（支付方式、支付时间、流水号）
2. 更新订单状态为`PAID`（已付款）
3. 创建店铺流水记录(StoreFlow)
4. 发送订单状态变更消息
5. 根据订单类型更新订单状态:
   - 普通订单 → `UNDELIVERED`（待发货）
   - 虚拟订单 → `TAKE`（待核验）
   - 自提订单 → `STAY_PICKED_UP`（待自提）

**状态变更:**
- 订单状态: `UNPAID` → `UNDELIVERED/TAKE/STAY_PICKED_UP`
- 支付状态: `UNPAID` → `PAID`

### 2.3 订单发货阶段

#### 步骤6: 商家发货
```java
位置: framework/src/main/java/cn/lili/modules/order/order/service/OrderService.java:176
方法: delivery(String orderSn, String invoiceNumber, String logisticsId)
```

**处理流程:**
1. 验证订单状态（必须是`UNDELIVERED`）
2. 填写物流信息（物流公司、物流单号）
3. 更新订单状态为`DELIVERED`（已发货）
4. 更新发货状态为`DELIVERED`
5. 记录发货时间
6. 发送订单状态变更消息

**支持部分发货:**
```java
方法: partDelivery(PartDeliveryParamsDTO partDeliveryParamsDTO)
```

**状态变更:**
- 订单状态: `UNDELIVERED` → `DELIVERED`
- 发货状态: `UNDELIVERED` → `DELIVERED`

### 2.4 订单收货阶段

#### 步骤7: 确认收货
```java
位置: framework/src/main/java/cn/lili/modules/order/order/service/OrderService.java:233
方法: complete(String orderSn)
```

**处理流程:**
1. 验证订单状态（必须是`DELIVERED`已发货）
2. 更新订单状态为`COMPLETED`（已完成）
3. 更新发货状态为`RECEIVED`（已收货）
4. 记录完成时间
5. 发送商品完成消息（用于统计等）
6. 触发分销结算
7. 发送订单状态变更消息

**状态变更:**
- 订单状态: `DELIVERED` → `COMPLETED`
- 发货状态: `DELIVERED` → `RECEIVED`

#### 步骤8: 自动确认收货
```java
位置: consumer/src/main/java/cn/lili/timetask/handler/impl/order/OrderEveryDayTaskExecute.java:147
方法: completedOrder(OrderSetting orderSetting)
```

**定时任务处理:**
- 每天执行一次
- 查询发货时间超过设置天数的订单
- 自动调用`systemComplete`完成订单

### 2.5 订单评价阶段

#### 步骤9: 商品评价
```java
位置: consumer/src/main/java/cn/lili/timetask/handler/impl/order/OrderEveryDayTaskExecute.java:176
方法: memberEvaluation(OrderSetting orderSetting)
```

**评价流程:**
- 用户主动评价：调用会员评价服务
- 自动好评：定时任务在订单完成N天后自动生成好评

### 2.6 订单取消流程

#### 取消场景1: 用户主动取消
```java
位置: framework/src/main/java/cn/lili/modules/order/order/service/OrderService.java:155
方法: cancel(String orderSn, String reason)
```

**处理流程:**
1. 验证订单状态（只能取消未付款订单）
2. 更新订单状态为`CANCELLED`
3. 恢复商品库存
4. 返还优惠券
5. 记录取消原因

#### 取消场景2: 超时自动取消
```java
位置: consumer/src/main/java/cn/lili/timetask/handler/impl/order/CancelOrderTaskExecute.java:44
方法: execute()
```

**定时任务处理:**
- 每分钟执行一次
- 查询创建时间超过设置分钟数的未付款订单
- 调用`systemCancel`自动取消订单

#### 取消场景3: 系统取消
```java
位置: framework/src/main/java/cn/lili/modules/order/order/service/OrderService.java:38
方法: systemCancel(String orderSn, String reason, Boolean refundMoney)
```

**处理流程:**
1. 更新订单状态为`CANCELLED`
2. 根据参数决定是否退款
3. 恢复库存和优惠券
4. 记录取消原因

**状态变更:**
- 订单状态: 任意状态 → `CANCELLED`
- 支付状态: 如已付款则退款

## 三、售后流程

### 3.1 售后申请
```java
位置: framework/src/main/java/cn/lili/modules/order/aftersale/entity/dos/AfterSale.java
```

**售后类型:**
- `RETURN_GOODS` - 退货退款
- `RETURN_MONEY` - 仅退款

**售后状态流转:**
1. `APPLY` - 申请售后
2. `PASS` - 商家通过
3. `REFUSE` - 商家拒绝
4. `BUYER_RETURN` - 买家退货
5. `SELLER_CONFIRM` - 商家确认收货
6. `COMPLETE` - 售后完成

### 3.2 售后完成处理
```java
位置: consumer/src/main/java/cn/lili/event/impl/OrderStatusHandlerExecute.java:52
方法: afterSaleStatusChange(AfterSale afterSale)
```

**处理流程:**
1. 更新订单项退款状态
2. 累计退款金额
3. 判断是否全部商品退款
4. 如全部退款则关闭订单

### 3.3 售后时效控制
```java
位置: consumer/src/main/java/cn/lili/timetask/handler/impl/order/OrderEveryDayTaskExecute.java:216
方法: closeAfterSale(OrderSetting orderSetting)
```

**定时任务:**
- 每天执行一次
- 订单完成N天后关闭售后申请入口

## 四、特殊订单类型

### 4.1 虚拟订单
**流程:** 创建 → 支付 → 核验 → 完成

核验方法:
```java
位置: framework/src/main/java/cn/lili/modules/order/order/service/OrderService.java:209
方法: take(String orderSn, String verificationCode)
```

### 4.2 自提订单
**流程:** 创建 → 支付 → 配货 → 自提核验 → 完成

**特点:**
- 需要填写自提点信息
- 生成提货码
- 通过提货码核验

### 4.3 拼团订单
**流程:** 创建 → 支付 → 等待成团 → 成团成功 → 发货 → 完成

**成团逻辑:**
```java
位置: framework/src/main/java/cn/lili/modules/order/order/service/OrderService.java:278
方法: agglomeratePintuanOrder(String pintuanId, String parentOrderSn)
```

## 五、订单核心数据模型

### 5.1 Order（订单主表）
```java
位置: framework/src/main/java/cn/lili/modules/order/order/entity/dos/Order.java
```

**核心字段:**
- `sn` - 订单编号
- `tradeSn` - 交易编号
- `orderStatus` - 订单状态
- `payStatus` - 支付状态
- `deliverStatus` - 发货状态
- `flowPrice` - 总价格
- `goodsPrice` - 商品价格
- `freightPrice` - 运费
- `discountPrice` - 优惠金额

### 5.2 Trade（交易表）
```java
位置: framework/src/main/java/cn/lili/modules/order/order/entity/dos/Trade.java
```

**说明:** 一次交易可能包含多个订单（多店铺）

### 5.3 OrderItem（订单项表）
**说明:** 订单中的具体商品信息

### 5.4 StoreFlow（店铺流水表）
**说明:** 记录订单的资金流水，用于结算

## 六、消息队列与事件

### 6.1 订单消息标签
```java
位置: framework/src/main/java/cn/lili/rocketmq/tags/OrderTagsEnum.java
```

- `ORDER_CREATE` - 订单创建
- `STATUS_CHANGE` - 订单状态变更

### 6.2 订单消息监听器
```java
位置: consumer/src/main/java/cn/lili/listener/OrderMessageListener.java
```

**监听处理:**
1. 订单创建事件 - 触发各业务模块的订单创建处理
2. 订单状态变更事件 - 触发各业务模块的状态变更处理

## 七、定时任务总览

| 任务名称 | 执行频率 | 功能说明 |
|---------|---------|---------|
| 自动取消订单 | 每分钟 | 取消超时未付款订单 |
| 自动确认收货 | 每天 | 自动确认超期未收货订单 |
| 自动好评 | 每天 | 自动生成好评 |
| 关闭售后申请 | 每天 | 关闭超期订单的售后入口 |
| 关闭交易投诉 | 每天 | 关闭超期订单的投诉入口 |
| 生成店铺结算单 | 每天 | 生成店铺月度结算单 |

## 八、订单状态流转图

```
[创建订单] → UNPAID(未付款)
    ↓
[支付订单] → PAID(已付款) / UNDELIVERED(待发货)
    ↓
[商家发货] → DELIVERED(已发货)
    ↓
[确认收货] → COMPLETED(已完成)
    ↓
[订单评价]

任意环节可能触发:
- [取消订单] → CANCELLED(已关闭)
- [申请售后] → 售后流程
```

## 九、关键业务规则

1. **订单创建规则:**
   - 必须选择有效的收货地址（实物商品）
   - 必须在配送范围内
   - 优惠券和积分在创建时扣除

2. **订单支付规则:**
   - 只有未付款订单可以支付
   - 支付金额为0的订单自动完成支付

3. **订单发货规则:**
   - 只有待发货订单可以发货
   - 支持部分发货功能
   - 发货必须填写物流信息

4. **订单取消规则:**
   - 用户只能取消未付款订单
   - 已付款订单需要通过售后流程
   - 超时订单系统自动取消

5. **订单完成规则:**
   - 必须是已发货状态
   - 可手动确认或自动确认
   - 完成后不可取消

6. **售后规则:**
   - 订单完成后N天内可申请售后
   - 全部商品退款后订单自动关闭

## 十、总结

订单业务流程是电商系统的核心流程，涉及订单创建、支付、发货、收货、评价、售后等多个环节。系统通过状态机模式管理订单状态流转，通过消息队列实现异步处理，通过定时任务处理超时订单。整个流程设计考虑了多种订单类型（普通、虚拟、自提、拼团等）和特殊场景（部分发货、售后等），保证了业务的完整性和健壮性。
